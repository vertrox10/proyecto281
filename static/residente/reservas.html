{% extends "residente/base_residente.html" %}

{% block title %}Reservas de Áreas Comunes{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='residente/reservas.css') }}">
{% endblock %}

{% block content %}
<div class="reservas-header">
    <h1><i class="fas fa-calendar-alt"></i> Reservas de Áreas Comunes</h1>
    <p>Gestiona tus reservas de áreas comunes del edificio</p>
</div>

<div class="reservas-content">
    <!-- Áreas Disponibles -->
    <div class="section-card">
        <div class="card-header">
            <h2><i class="fas fa-swimming-pool"></i> Áreas Disponibles</h2>
        </div>
        <div class="areas-grid">
            {% for area in areas %}
            <div class="area-card" data-area-id="{{ area.id_area_comun }}">
                <div class="area-image">
                    {% if area.imagen %}
                    <img src="{{ area.imagen }}" alt="{{ area.nombre }}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    {% endif %}
                    <div class="area-placeholder {% if area.imagen %}hidden{% endif %}">
                        <i class="fas fa-{{ 'swimming-pool' if area.id_area_comun == 1 else 'car' if area.id_area_comun == 2 else 'glass-cheers' }}"></i>
                    </div>
                </div>
                <div class="area-info">
                    <h3>{{ area.nombre }}</h3>
                    <p class="area-desc">{{ area.descripcion }}</p>
                    
                    <div class="area-details">
                        <span class="capacity">
                            <i class="fas fa-users"></i> Capacidad: {{ area.capacidad }} personas
                        </span>
                        <span class="price">
                            <i class="fas fa-money-bill-wave"></i> ${{ area.tarifa_hora }}/hora
                        </span>
                    </div>
                    
                    <div class="area-horario">
                        <i class="fas fa-clock"></i>
                        <span>Horario: {{ area.horario_inicio }} - {{ area.horario_fin }}</span>
                    </div>
                    
                    <div class="area-reglas">
                        <i class="fas fa-info-circle"></i>
                        <span>{{ area.reglas[:80] }}...</span>
                    </div>
                    
                    <button class="btn btn-primary reservar-btn" data-area-id="{{ area.id_area_comun }}">
                        <i class="fas fa-calendar-plus"></i> Reservar
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Calendario de Disponibilidad -->
    <div class="section-card">
        <div class="card-header">
            <h2><i class="fas fa-calendar-week"></i> Calendario de Disponibilidad</h2>
        </div>
        <div class="calendario-container">
            <div class="calendario-filtros">
                <div class="form-group">
                    <label class="form-label">Área</label>
                    <select id="filtroAreaCalendario" class="form-control">
                        <option value="1">Piscina</option>
                        <option value="2">Garaje</option>
                        <option value="3">Salón de Eventos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Mes</label>
               <input type="month" id="filtroMesCalendario" class="form-control">
                </div>
            </div>
            
            <div class="calendario-grid" id="calendarioGrid">
                <!-- El calendario se cargará dinámicamente -->
            </div>
            
            <div class="calendario-leyenda">
                <div class="leyenda-item">
                    <span class="leyenda-color disponible"></span>
                    <span>Disponible</span>
                </div>
                <div class="leyenda-item">
                    <span class="leyenda-color ocupado"></span>
                    <span>Ocupado</span>
                </div>
                <div class="leyenda-item">
                    <span class="leyenda-color hoy"></span>
                    <span>Hoy</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Mis Reservas Activas -->
    <div class="section-card">
        <div class="card-header">
            <h2><i class="fas fa-clock"></i> Mis Reservas Activas</h2>
        </div>
        <div class="reservas-list">
            {% if reservas_activas %}
                {% for reserva in reservas_activas %}
                <div class="reserva-card {{ reserva.estado }}" data-reserva-id="{{ reserva.id_reserva }}">
                    <div class="reserva-header">
                        <div class="reserva-info">
                            <h3>{{ reserva.area_nombre }}</h3>
                            <div class="reserva-meta">
                                <span class="reserva-fecha">{{ reserva.fecha_formateada }}</span>
                                <span class="reserva-duracion">{{ reserva.duracion_horas }} hora(s)</span>
                                <span class="reserva-monto">${{ reserva.monto_total }}</span>
                            </div>
                        </div>
                        <div class="reserva-estado">
                            <span class="estado estado-{{ reserva.estado }}">{{ reserva.estado }}</span>
                        </div>
                    </div>
                    
                    <!-- Información de Cancelación -->
                    {% if reserva.estado in ['pendiente', 'confirmada'] %}
                    <div class="reserva-cancelacion-info">
                        <i class="fas fa-info-circle"></i>
                        {% if reserva.puede_cancelar_con_reembolso %}
                        <span>Cancelación con {{ reserva.reembolso_porcentaje }}% de reembolso disponible</span>
                        {% else %}
                        <span>Cancelación sin reembolso (menos de 24 horas de anticipación)</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <div class="reserva-actions">
                        {% if reserva.estado == 'confirmada' and reserva.qr_code %}
                        <button class="btn btn-outline ver-qr-btn" data-qr="{{ reserva.qr_code }}">
                            <i class="fas fa-qrcode"></i> Ver QR
                        </button>
                        {% endif %}
                        
                        {% if reserva.estado == 'pendiente' %}
                        <button class="btn btn-primary pagar-reserva-btn" data-id="{{ reserva.id_reserva }}">
                            <i class="fas fa-credit-card"></i> Pagar Reserva
                        </button>
                        {% endif %}
                        
                        {% if reserva.estado in ['pendiente', 'confirmada'] %}
                        <button class="btn btn-danger cancelar-reserva-btn" data-id="{{ reserva.id_reserva }}" data-reembolso="{{ reserva.reembolso_porcentaje }}">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        {% endif %}
                    </div>
                    
                    {% if reserva.estado == 'confirmada' and reserva.qr_code %}
                    <div class="qr-container hidden" id="qr-{{ reserva.id_reserva }}">
                        <img src="data:image/png;base64,{{ reserva.qr_code }}" alt="QR Reserva">
                        <p class="qr-info">Presenta este código QR al acceder al área común</p>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
            <div class="empty-state">
                <i class="fas fa-calendar-times"></i>
                <h3>No tienes reservas activas</h3>
                <p>Realiza tu primera reserva de un área común.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Nueva Reserva -->
<div id="modalReserva" class="modal">
    <div class="modal-content large">
        <div class="modal-header">
            <h3>Nueva Reserva - <span id="modalAreaNombre"></span></h3>
            <button class="btn-icon" id="cerrarReservaBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="formReserva">
                <input type="hidden" id="areaSeleccionada" name="id_area_comun">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Fecha</label>
                        <input type="date" id="fechaReserva" name="fecha" class="form-control" 
                               min="{{ fecha_minima }}" max="{{ fecha_maxima }}" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Hora</label>
                        <select id="horaReserva" name="hora" class="form-control" required disabled>
                            <option value="">Primero seleccione una fecha</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Duración (horas)</label>
                        <select id="duracionReserva" name="duracion" class="form-control" required>
                            <option value="1">1 hora</option>
                            <option value="2">2 horas</option>
                            <option value="3">3 horas</option>
                            <option value="4">4 horas</option>
                        </select>
                    </div>
                </div>
                
                <div class="area-info-modal" id="areaInfoModal">
                    <!-- Información del área se cargará aquí -->
                </div>
                
                <div class="disponibilidad-info">
                    <div id="disponibilidadResultado"></div>
                </div>
                
                <div class="resumen-reserva hidden" id="resumenReserva">
                    <h4>Resumen de Reserva</h4>
                    <div class="resumen-grid">
                        <div class="resumen-item">
                            <label>Área:</label>
                            <span id="resumenArea"></span>
                        </div>
                        <div class="resumen-item">
                            <label>Fecha y Hora:</label>
                            <span id="resumenFechaHora"></span>
                        </div>
                        <div class="resumen-item">
                            <label>Duración:</label>
                            <span id="resumenDuracion"></span>
                        </div>
                        <div class="resumen-item">
                            <label>Tarifa por hora:</label>
                            <span id="resumenTarifa"></span>
                        </div>
                        <div class="resumen-item total">
                            <label>Total a pagar:</label>
                            <span id="resumenTotal"></span>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancelarReservaBtn">Cancelar</button>
            <button class="btn btn-primary" id="confirmarReservaBtn" disabled>
                <i class="fas fa-calendar-check"></i> Confirmar Reserva
            </button>
        </div>
    </div>
</div>

<!-- Modal Pago Reserva -->
<div id="modalPagoReserva" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Pagar Reserva</h3>
            <button class="btn-icon" id="cerrarPagoReservaBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="pago-info">
                <h4>Resumen del Pago</h4>
                <div class="pago-detalles">
                    <p><strong>Monto a pagar:</strong> $<span id="montoPagoReserva">0.00</span></p>
                    <p><strong>Reserva ID:</strong> #<span id="idReservaPago"></span></p>
                </div>
            </div>
            
            <div class="metodos-pago">
                <h4>Seleccione método de pago:</h4>
                <div class="metodo-option">
                    <input type="radio" id="tigoMoneyReserva" name="metodoPagoReserva" value="tigo_money">
                    <label for="tigoMoneyReserva">
                        <i class="fas fa-mobile-alt"></i>
                        <span>Tigo Money</span>
                    </label>
                </div>
                <div class="metodo-option">
                    <input type="radio" id="billeteraReserva" name="metodoPagoReserva" value="billetera_virtual">
                    <label for="billeteraReserva">
                        <i class="fas fa-wallet"></i>
                        <span>Billetera Virtual</span>
                    </label>
                </div>
                <div class="metodo-option">
                    <input type="radio" id="criptoReserva" name="metodoPagoReserva" value="criptomoneda">
                    <label for="criptoReserva">
                        <i class="fas fa-coins"></i>
                        <span>Criptomoneda</span>
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancelarPagoReservaBtn">Cancelar</button>
            <button class="btn btn-primary" id="procesarPagoReservaBtn" disabled>
                <i class="fas fa-credit-card"></i> Procesar Pago
            </button>
        </div>
    </div>
</div>

<!-- Modal Política Cancelación -->
<div id="modalPoliticaCancelacion" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Política de Cancelación</h3>
            <button class="btn-icon" id="cerrarPoliticaBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="politica-content">
                <h4>Condiciones de Reembolso</h4>
                <div class="politica-item">
                    <div class="politica-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="politica-text">
                        <strong>Cancelación con 24+ horas de anticipación:</strong>
                        <span>70% de reembolso del monto pagado</span>
                    </div>
                </div>
                <div class="politica-item">
                    <div class="politica-icon">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="politica-text">
                        <strong>Cancelación con menos de 24 horas:</strong>
                        <span>No aplica reembolso</span>
                    </div>
                </div>
                
                <div class="politica-detalle">
                    <p><strong>Reserva ID:</strong> #<span id="politicaReservaId"></span></p>
                    <p><strong>Monto total:</strong> $<span id="politicaMontoTotal">0.00</span></p>
                    <p><strong>Reembolso aplicable:</strong> $<span id="politicaReembolso">0.00</span> (<span id="politicaPorcentaje">0</span>%)</p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancelarPoliticaBtn">Volver</button>
            <button class="btn btn-danger" id="confirmarCancelacionBtn">
                <i class="fas fa-times"></i> Confirmar Cancelación
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let areaSeleccionada = null;
        let reservaPendienteId = null;
        let reservaCancelarId = null;

        // Event listeners para botones de reserva
        document.querySelectorAll('.reservar-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const areaId = this.getAttribute('data-area-id');
                abrirModalReserva(areaId);
            });
        });

        // Cambios en el formulario de reserva
        document.getElementById('fechaReserva').addEventListener('change', function() {
            cargarHorariosDisponibles();
        });

        document.getElementById('duracionReserva').addEventListener('change', verificarDisponibilidad);

        // Filtros del calendario
        document.getElementById('filtroAreaCalendario').addEventListener('change', cargarCalendario);
        document.getElementById('filtroMesCalendario').addEventListener('change', cargarCalendario);

        // Modal reserva
        document.getElementById('cerrarReservaBtn').addEventListener('click', cerrarModalReserva);
        document.getElementById('cancelarReservaBtn').addEventListener('click', cerrarModalReserva);
        document.getElementById('confirmarReservaBtn').addEventListener('click', crearReserva);

        // Modal pago
        document.getElementById('cerrarPagoReservaBtn').addEventListener('click', cerrarModalPagoReserva);
        document.getElementById('cancelarPagoReservaBtn').addEventListener('click', cerrarModalPagoReserva);
        document.getElementById('procesarPagoReservaBtn').addEventListener('click', procesarPagoReserva);

        // Modal política cancelación
        document.getElementById('cerrarPoliticaBtn').addEventListener('click', cerrarModalPolitica);
        document.getElementById('cancelarPoliticaBtn').addEventListener('click', cerrarModalPolitica);
        document.getElementById('confirmarCancelacionBtn').addEventListener('click', confirmarCancelacion);

        // Métodos de pago
        document.querySelectorAll('input[name="metodoPagoReserva"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('procesarPagoReservaBtn').disabled = !this.checked;
            });
        });

        // Botones de acciones
        document.querySelectorAll('.pagar-reserva-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const reservaId = this.getAttribute('data-id');
                abrirModalPagoReserva(reservaId);
            });
        });

        document.querySelectorAll('.cancelar-reserva-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const reservaId = this.getAttribute('data-id');
                const reembolsoPorcentaje = this.getAttribute('data-reembolso');
                abrirModalPolitica(reservaId, reembolsoPorcentaje);
            });
        });

        document.querySelectorAll('.ver-qr-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const qrContainer = this.closest('.reserva-card').querySelector('.qr-container');
                qrContainer.classList.toggle('hidden');
            });
        });

        // Cerrar modales al hacer clic fuera
        document.getElementById('modalReserva').addEventListener('click', function(event) {
            if (event.target === this) cerrarModalReserva();
        });

        document.getElementById('modalPagoReserva').addEventListener('click', function(event) {
            if (event.target === this) cerrarModalPagoReserva();
        });

        document.getElementById('modalPoliticaCancelacion').addEventListener('click', function(event) {
            if (event.target === this) cerrarModalPolitica();
        });

        // Cargar calendario inicial
        cargarCalendario();
    });

    function abrirModalReserva(areaId) {
        const areaCard = document.querySelector(`[data-area-id="${areaId}"]`);
        const areaNombre = areaCard.querySelector('h3').textContent;
        
        document.getElementById('areaSeleccionada').value = areaId;
        document.getElementById('modalAreaNombre').textContent = areaNombre;
        document.getElementById('modalReserva').style.display = 'flex';
        
        // Resetear formulario
        document.getElementById('formReserva').reset();
        document.getElementById('horaReserva').innerHTML = '<option value="">Primero seleccione una fecha</option>';
        document.getElementById('horaReserva').disabled = true;
        document.getElementById('disponibilidadResultado').innerHTML = '';
        document.getElementById('resumenReserva').classList.add('hidden');
        document.getElementById('confirmarReservaBtn').disabled = true;
        
        // Cargar información del área
        cargarInfoArea(areaId);
        
        areaSeleccionada = {
            id: parseInt(areaId),
            nombre: areaNombre,
            tarifa: parseFloat(areaCard.querySelector('.price').textContent.match(/\$([\d.]+)/)[1])
        };
    }

    function cargarInfoArea(areaId) {
        const areas = {
            1: {
                nombre: 'Piscina',
                horario: '08:00 - 20:00',
                capacidad: '20 personas',
                reglas: 'Uso obligatorio de gorros de baño. No se permite el ingreso de alimentos. Los niños deben estar acompañados por adultos.',
                icono: 'swimming-pool'
            },
            2: {
                nombre: 'Garaje de Visitantes',
                horario: '24 horas',
                capacidad: '1 vehículo',
                reglas: 'Solo para vehículos de visitantes. Presentar identificación al ingresar. No se permite pernoctar.',
                icono: 'car'
            },
            3: {
                nombre: 'Salón de Eventos',
                horario: '09:00 - 22:00',
                capacidad: '50 personas',
                reglas: 'Prohibido el consumo de alcohol. Debe finalizar a las 22:00. Responsable por daños al mobiliario.',
                icono: 'glass-cheers'
            }
        };
        
        const area = areas[areaId];
        const infoHtml = `
            <div class="area-info-content">
                <div class="area-info-header">
                    <i class="fas fa-${area.icono}"></i>
                    <h4>${area.nombre}</h4>
                </div>
                <div class="area-info-details">
                    <div class="info-item">
                        <i class="fas fa-clock"></i>
                        <span><strong>Horario:</strong> ${area.horario}</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-users"></i>
                        <span><strong>Capacidad:</strong> ${area.capacidad}</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-info-circle"></i>
                        <span><strong>Reglas:</strong> ${area.reglas}</span>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('areaInfoModal').innerHTML = infoHtml;
    }

    async function cargarHorariosDisponibles() {
        const fecha = document.getElementById('fechaReserva').value;
        const areaId = document.getElementById('areaSeleccionada').value;

        if (!fecha) return;

        const horaSelect = document.getElementById('horaReserva');
        horaSelect.innerHTML = '<option value="">Cargando horarios...</option>';
        horaSelect.disabled = true;

        try {
            const response = await fetch('/residentes/reservas/api/obtener_disponibilidad_fecha', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    fecha: fecha,
                    id_area_comun: areaId
                })
            });

            const data = await response.json();

            if (data.success) {
                horaSelect.innerHTML = '<option value="">Seleccionar hora</option>';
                
                if (data.horarios_disponibles.length > 0) {
                    data.horarios_disponibles.forEach(hora => {
                        const option = document.createElement('option');
                        option.value = hora;
                        option.textContent = hora;
                        horaSelect.appendChild(option);
                    });
                    horaSelect.disabled = false;
                } else {
                    horaSelect.innerHTML = '<option value="">No hay horarios disponibles</option>';
                }
                
                // Mostrar horario permitido
                document.getElementById('disponibilidadResultado').innerHTML = `
                    <div class="info">
                        <i class="fas fa-info-circle"></i>
                        Horario permitido: ${data.horario_permitido}
                    </div>
                `;
            } else {
                horaSelect.innerHTML = '<option value="">Error al cargar horarios</option>';
            }
        } catch (error) {
            console.error('Error:', error);
            horaSelect.innerHTML = '<option value="">Error al cargar horarios</option>';
        }
    }

    async function verificarDisponibilidad() {
        const fecha = document.getElementById('fechaReserva').value;
        const hora = document.getElementById('horaReserva').value;
        const duracion = document.getElementById('duracionReserva').value;

        if (!fecha || !hora || !areaSeleccionada) return;

        const resultadoDiv = document.getElementById('disponibilidadResultado');
        resultadoDiv.innerHTML = '<div class="loading">Verificando disponibilidad...</div>';

        try {
            const response = await fetch('/residentes/reservas/api/verificar_disponibilidad', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id_area_comun: areaSeleccionada.id,
                    fecha: fecha,
                    hora: hora,
                    duracion: parseInt(duracion)
                })
            });

            const data = await response.json();

            if (data.success) {
                if (data.disponible) {
                    resultadoDiv.innerHTML = `<div class="disponible">✅ ${data.message}</div>`;
                    mostrarResumenReserva(fecha, hora, duracion);
                    document.getElementById('confirmarReservaBtn').disabled = false;
                } else {
                    resultadoDiv.innerHTML = `<div class="no-disponible">❌ ${data.message}</div>`;
                    document.getElementById('confirmarReservaBtn').disabled = true;
                    document.getElementById('resumenReserva').classList.add('hidden');
                }
            } else {
                resultadoDiv.innerHTML = `<div class="error">⚠️ ${data.message}</div>`;
                document.getElementById('confirmarReservaBtn').disabled = true;
            }
        } catch (error) {
            console.error('Error:', error);
            resultadoDiv.innerHTML = '<div class="error">⚠️ Error al verificar disponibilidad</div>';
            document.getElementById('confirmarReservaBtn').disabled = true;
        }
    }

    function mostrarResumenReserva(fecha, hora, duracion) {
        const total = areaSeleccionada.tarifa * parseInt(duracion);
        
        document.getElementById('resumenArea').textContent = areaSeleccionada.nombre;
        document.getElementById('resumenFechaHora').textContent = `${fecha} ${hora}`;
        document.getElementById('resumenDuracion').textContent = `${duracion} hora(s)`;
        document.getElementById('resumenTarifa').textContent = `$${areaSeleccionada.tarifa}/hora`;
        document.getElementById('resumenTotal').textContent = `$${total.toFixed(2)}`;
        
        document.getElementById('resumenReserva').classList.remove('hidden');
    }

    async function crearReserva() {
        const formData = new FormData(document.getElementById('formReserva'));
        const data = Object.fromEntries(formData);

        if (!data.fecha || !data.hora || !data.duracion) {
            alert('Por favor complete todos los campos');
            return;
        }

        try {
            const response = await fetch('/residentes/reservas/api/crear_reserva', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                alert('Reserva creada exitosamente. Proceda al pago.');
                reservaPendienteId = result.reserva_id;
                cerrarModalReserva();
                abrirModalPagoReserva(result.reserva_id, result.monto_total);
            } else {
                alert('Error al crear reserva: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al crear la reserva');
        }
    }

    function abrirModalPagoReserva(reservaId, monto) {
        document.getElementById('idReservaPago').textContent = reservaId;
        document.getElementById('montoPagoReserva').textContent = monto.toFixed(2);
        
        // Resetear formulario de pago
        document.querySelectorAll('input[name="metodoPagoReserva"]').forEach(radio => {
            radio.checked = false;
        });
        document.getElementById('procesarPagoReservaBtn').disabled = true;
        
        document.getElementById('modalPagoReserva').style.display = 'flex';
        reservaPendienteId = reservaId;
    }

    function cerrarModalPagoReserva() {
        document.getElementById('modalPagoReserva').style.display = 'none';
        reservaPendienteId = null;
    }

    async function procesarPagoReserva() {
        const metodoSeleccionado = document.querySelector('input[name="metodoPagoReserva"]:checked');
        
        if (!metodoSeleccionado || !reservaPendienteId) {
            alert('Por favor seleccione un método de pago');
            return;
        }

        if (confirm('¿Confirmar el pago de esta reserva?')) {
            try {
                const response = await fetch('/residentes/reservas/api/pagar_reserva', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id_reserva: reservaPendienteId,
                        metodo: metodoSeleccionado.value
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Pago procesado exitosamente. Reserva confirmada.');
                    cerrarModalPagoReserva();
                    location.reload();
                } else {
                    alert('Error al procesar pago: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al procesar el pago');
            }
        }
    }

    function abrirModalPolitica(reservaId, reembolsoPorcentaje) {
        reservaCancelarId = reservaId;
        
        // Obtener información de la reserva
        const reservaCard = document.querySelector(`[data-reserva-id="${reservaId}"]`);
        const montoTotal = parseFloat(reservaCard.querySelector('.reserva-monto').textContent.replace('$', ''));
        const montoReembolso = (montoTotal * parseInt(reembolsoPorcentaje)) / 100;
        
        document.getElementById('politicaReservaId').textContent = reservaId;
        document.getElementById('politicaMontoTotal').textContent = montoTotal.toFixed(2);
        document.getElementById('politicaReembolso').textContent = montoReembolso.toFixed(2);
        document.getElementById('politicaPorcentaje').textContent = reembolsoPorcentaje;
        
        document.getElementById('modalPoliticaCancelacion').style.display = 'flex';
    }

    function cerrarModalPolitica() {
        document.getElementById('modalPoliticaCancelacion').style.display = 'none';
        reservaCancelarId = null;
    }

    async function confirmarCancelacion() {
        if (!reservaCancelarId) return;

        if (confirm('¿Está seguro de cancelar esta reserva?')) {
            try {
                const response = await fetch(`/residentes/reservas/api/cancelar_reserva/${reservaCancelarId}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    cerrarModalPolitica();
                    location.reload();
                } else {
                    alert('Error al cancelar reserva: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cancelar la reserva');
            }
        }
    }

    async function cargarCalendario() {
        const areaId = document.getElementById('filtroAreaCalendario').value;
        const mes = document.getElementById('filtroMesCalendario').value;
        
        const calendarioGrid = document.getElementById('calendarioGrid');
        calendarioGrid.innerHTML = '<div class="loading-calendario">Cargando calendario...</div>';

        try {
            // Simular carga de datos del calendario
            setTimeout(() => {
                generarCalendarioVisual(areaId, mes);
            }, 500);
        } catch (error) {
            console.error('Error:', error);
            calendarioGrid.innerHTML = '<div class="error">Error al cargar el calendario</div>';
        }
    }

    function generarCalendarioVisual(areaId, mes) {
        const calendarioGrid = document.getElementById('calendarioGrid');
        const [ano, mesNum] = mes.split('-').map(Number);
        
        // Generar días del mes
        const diasEnMes = new Date(ano, mesNum, 0).getDate();
        const primerDia = new Date(ano, mesNum - 1, 1).getDay();
        
        let calendarioHTML = '<div class="calendario-header">';
        const diasSemana = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
        diasSemana.forEach(dia => {
            calendarioHTML += `<div class="calendario-dia-header">${dia}</div>`;
        });
        calendarioHTML += '</div><div class="calendario-dias">';
        
        // Espacios vacíos para alinear el primer día
        for (let i = 0; i < primerDia; i++) {
            calendarioHTML += '<div class="calendario-dia vacio"></div>';
        }
        
        const hoy = new Date();
        const hoyFormato = hoy.toISOString().split('T')[0];
        
        for (let dia = 1; dia <= diasEnMes; dia++) {
            const fechaCompleta = `${ano}-${mesNum.toString().padStart(2, '0')}-${dia.toString().padStart(2, '0')}`;
            const esHoy = fechaCompleta === hoyFormato;
            const esPasado = new Date(fechaCompleta) < new Date(hoyFormato);
            
            // Simular disponibilidad (en una implementación real, esto vendría del backend)
            const disponible = Math.random() > 0.3 && !esPasado;
            
            let claseDia = 'calendario-dia';
            if (esHoy) claseDia += ' hoy';
            if (esPasado) claseDia += ' pasado';
            if (!disponible && !esPasado) claseDia += ' ocupado';
            if (disponible) claseDia += ' disponible';
            
            calendarioHTML += `
                <div class="${claseDia}" data-fecha="${fechaCompleta}">
                    <span class="dia-numero">${dia}</span>
                    ${disponible ? '<div class="dia-estado">Disponible</div>' : ''}
                </div>
            `;
        }
        
        calendarioHTML += '</div>';
        calendarioGrid.innerHTML = calendarioHTML;
        
        // Agregar event listeners a los días disponibles
        calendarioGrid.querySelectorAll('.calendario-dia.disponible').forEach(dia => {
            dia.addEventListener('click', function() {
                const fecha = this.getAttribute('data-fecha');
                document.getElementById('fechaReserva').value = fecha;
                // Si el modal está abierto, cargar horarios
                if (document.getElementById('modalReserva').style.display === 'flex') {
                    cargarHorariosDisponibles();
                }
            });
        });
    }

    function cerrarModalReserva() {
        document.getElementById('modalReserva').style.display = 'none';
        areaSeleccionada = null;
    }
</script>
{% endblock %}