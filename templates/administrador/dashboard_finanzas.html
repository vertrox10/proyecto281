{% extends 'administrador/base.html' %}

{% block title %}Dashboard Finanzas{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    :root {
        --primary: #4361ee;
        --primary-dark: #3a56d4;
        --primary-light: #4895ef;
        --secondary: #7209b7;
        --success: #4cc9f0;
        --danger: #f72585;
        --warning: #f8961e;
        --info: #4895ef;
        --dark: #2b2d42;
        --light: #f8f9fa;
        --gray-100: #f8f9fa;
        --gray-200: #e9ecef;
        --gray-300: #dee2e6;
        --gray-400: #ced4da;
        --gray-500: #adb5bd;
        --gray-600: #6c757d;
        --gray-700: #495057;
        --gray-800: #343a40;
        --gray-900: #212529;
        --border-radius: 12px;
        --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --box-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .dashboard-container {
        padding: 24px;
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
        min-height: 100vh;
    }

    /* Header Styles */
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: var(--border-radius);
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        position: relative;
        overflow: hidden;
        box-shadow: var(--box-shadow-lg);
    }

    .header-content h1 {
        color: white !important;
        font-size: 2.25rem;
        font-weight: 700;
        margin: 0 0 0.5rem 0;
    }

    /* Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--box-shadow);
        border: 1px solid var(--gray-200);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
    }

    .stat-card.income::before { background: linear-gradient(135deg, #4cc9f0, #4361ee); }
    .stat-card.expenses::before { background: linear-gradient(135deg, #f72585, #b5179e); }
    .stat-card.profit::before { background: linear-gradient(135deg, #f8961e, #f3722c); }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--box-shadow-lg);
    }

    .stat-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .stat-info h3 {
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--gray-600);
        margin: 0 0 0.5rem 0;
    }

    .stat-value {
        font-size: 2.25rem;
        font-weight: 700;
        margin: 0.5rem 0;
        line-height: 1;
    }

    .stat-card.income .stat-value { color: #4cc9f0 !important; }
    .stat-card.expenses .stat-value { color: #f72585 !important; }
    .stat-card.profit .stat-value { color: #f8961e !important; }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }

    .stat-card.income .stat-icon { background: linear-gradient(135deg, #4cc9f0, #4361ee); }
    .stat-card.expenses .stat-icon { background: linear-gradient(135deg, #f72585, #b5179e); }
    .stat-card.profit .stat-icon { background: linear-gradient(135deg, #f8961e, #f3722c); }

    /* Main Grid Layout */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    /* Chart Cards */
    .chart-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        border: 1px solid var(--gray-200);
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .chart-card:hover {
        box-shadow: var(--box-shadow-lg);
    }

    .chart-header {
        padding: 1.5rem 1.5rem 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chart-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--dark);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .chart-body {
        padding: 1.5rem;
    }

    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }

    /* Custom Table Styles */
    .custom-table {
        width: 100%;
        margin: 0;
        border-collapse: separate;
        border-spacing: 0;
    }

    .custom-table thead th {
        background: var(--gray-100);
        color: var(--gray-700);
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .custom-table tbody tr {
        transition: all 0.3s ease;
    }

    .custom-table tbody tr:hover {
        background: var(--gray-100);
    }

    .custom-table tbody td {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--gray-200);
        font-size: 0.875rem;
        color: var(--gray-700);
    }

    /* Badge Styles */
    .badge-success-custom {
        background: rgba(76, 201, 240, 0.1) !important;
        color: #4cc9f0 !important;
        border: 1px solid rgba(76, 201, 240, 0.2) !important;
    }

    .badge-warning-custom {
        background: rgba(248, 150, 30, 0.1) !important;
        color: #f8961e !important;
        border: 1px solid rgba(248, 150, 30, 0.2) !important;
    }

    .badge-danger-custom {
        background: rgba(247, 37, 133, 0.1) !important;
        color: #f72585 !important;
        border: 1px solid rgba(247, 37, 133, 0.2) !important;
    }

    /* Override Bootstrap cards */
    .card {
        border: none !important;
        border-radius: var(--border-radius) !important;
        box-shadow: var(--box-shadow) !important;
        margin-bottom: 1.5rem;
    }

    .card-header {
        background: white !important;
        border-bottom: 1px solid var(--gray-200) !important;
        border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
    }

    @media (max-width: 768px) {
        .dashboard-container {
            padding: 1rem;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .chart-header {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }
    }
</style>

{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Dashboard de Finanzas - Últimos 7 Días</h1>
        <div class="d-flex gap-2">
            <select class="form-select form-select-sm" id="periodoSelect" onchange="cambiarPeriodo()">
                <option value="7dias" selected>Últimos 7 Días</option>
                <option value="mes">Este Mes</option>
                <option value="trimestre">Este Trimestre</option>
                <option value="anio">Año Actual</option>
            </select>
            <button class="btn btn-sm btn-outline-primary" onclick="exportarDatos()">
                <i class="fas fa-download"></i> Exportar
            </button>
        </div>
    </div>

    <!-- Tarjetas de Resumen -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-start border-success border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title text-muted mb-2">Total Ingresos</h5>
                            <h3 class="mb-0 text-success">${{ "%.2f"|format(total_ingresos|default(0)) }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-dollar-sign fa-2x text-success opacity-25"></i>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 {{ 'text-success' if (variacion_ingresos|default(0)) >= 0 else 'text-danger' }}">
                        <span class="fw-bold">{{ variacion_ingresos|default(0) }}%</span> vs período anterior
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-start border-danger border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title text-muted mb-2">Total Gastos</h5>
                            <h3 class="mb-0 text-danger">${{ "%.2f"|format(total_gastos|default(0)) }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-receipt fa-2x text-danger opacity-25"></i>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 {{ 'text-danger' if (variacion_gastos|default(0)) >= 0 else 'text-success' }}">
                        <span class="fw-bold">{{ variacion_gastos|default(0) }}%</span> vs período anterior
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-start border-primary border-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title text-muted mb-2">Utilidad Neta</h5>
                            <h3 class="mb-0 text-primary">${{ "%.2f"|format(utilidad_neta|default(0)) }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-line fa-2x text-primary opacity-25"></i>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 {{ 'text-primary' if (variacion_utilidad|default(0)) >= 0 else 'text-danger' }}">
                        <span class="fw-bold">{{ variacion_utilidad|default(0) }}%</span> vs período anterior
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos Principales -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Evolución Financiera - Últimos 7 Días</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Distribución de Ingresos</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos Secundarios -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Top Métodos de Pago</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Distribución de Gastos</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="doughnutChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tablas de Detalle -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Últimos Pagos Recibidos</h5>
                    <div class="input-group input-group-sm" style="width: 200px;">
                        <input type="text" class="form-control" placeholder="Buscar..." id="searchPagos">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="tablaPagos">
                            <thead class="table-light">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Descripción</th>
                                    <th>Monto</th>
                                    <th>Método</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pago in ultimos_pagos|default([]) %}
                                <tr>
                                    <td>{{ pago.fecha_pago.strftime('%d/%m/%Y') if pago.fecha_pago else 'N/A' }}</td>
                                    <td>{{ pago.descripcion or 'Pago' }}</td>
                                    <td>${{ "%.2f"|format(pago.monto|default(0)) }}</td>
                                    <td>{{ pago.metodo or 'N/A' }}</td>
                                    <td>
                                        <span class="badge bg-success">Pagado</span>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">No hay pagos recientes</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Deudas Pendientes</h5>
                    <div class="input-group input-group-sm" style="width: 200px;">
                        <input type="text" class="form-control" placeholder="Buscar..." id="searchDeudas">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="tablaDeudas">
                            <thead class="table-light">
                                <tr>
                                    <th>Concepto</th>
                                    <th>Monto</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for deuda in deudas_pendientes|default([]) %}
                                <tr>
                                    <td>{{ deuda.identificador or 'Deuda' }}</td>
                                    <td>${{ "%.2f"|format(deuda.monto|default(0)) }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'danger' if deuda.estado == 'vencido' else 'warning' }}">
                                            {{ deuda.estado|title if deuda.estado else 'Pendiente' }}
                                        </span>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">No hay deudas pendientes</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pasar datos de Python a JavaScript -->
<script>
    // Datos para gráficos - Últimos 7 días
    const datosGraficos = {
        evolucionMensual: {{ evolucion_mensual|tojson|default({'ingresos': [0,0,0,0,0,0,0], 'gastos': [0,0,0,0,0,0,0], 'labels': ['01/01','02/01','03/01','04/01','05/01','06/01','07/01']}) }},
        distribucionIngresos: {{ distribucion_ingresos|tojson|default({'labels': ['Sin datos'], 'data': [100]}) }},
        topIngresos: {{ top_ingresos|tojson|default({'labels': ['Sin datos'], 'data': [100]}) }},
        distribucionGastos: {{ distribucion_gastos|tojson|default({'labels': ['Sin datos'], 'data': [100]}) }}
    };
</script>
{% endblock %}

{% block extra_scripts %}
<!-- Cargar Chart.js desde CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Verificar que Chart.js esté cargado
function waitForChartJS(callback, maxAttempts = 10, attempt = 1) {
    if (typeof Chart !== 'undefined' && typeof Chart === 'function') {
        console.log('Chart.js cargado correctamente');
        callback();
    } else {
        console.log(`Intento ${attempt}/${maxAttempts}: Chart.js no cargado, reintentando...`);
        if (attempt >= maxAttempts) {
            console.error('Chart.js no se pudo cargar después de ' + maxAttempts + ' intentos');
            mostrarErrorChartJS();
            return;
        }
        setTimeout(() => waitForChartJS(callback, maxAttempts, attempt + 1), 500);
    }
}

function mostrarErrorChartJS() {
    // Mostrar mensajes de error en los contenedores de gráficos
    const chartContainers = document.querySelectorAll('.chart-container');
    chartContainers.forEach(container => {
        container.innerHTML = `
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <p>No se pudo cargar la librería de gráficos</p>
                <small>Recarga la página o verifica tu conexión a internet</small>
            </div>
        `;
    });
}

// Inicializar gráficos cuando Chart.js esté listo
waitForChartJS(function() {
    console.log('Inicializando gráficos...');
    inicializarGraficos();
});

function inicializarGraficos() {
    // Gráfico de Línea - Evolución Financiera (7 días)
    const lineCtx = document.getElementById('lineChart');
    if (lineCtx) {
        try {
            new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: datosGraficos.evolucionMensual.labels,
                    datasets: [
                        {
                            label: 'Ingresos',
                            data: datosGraficos.evolucionMensual.ingresos || [],
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 2
                        },
                        {
                            label: 'Gastos',
                            data: datosGraficos.evolucionMensual.gastos || [],
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: $${context.raw.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
            console.log('Gráfico de línea creado correctamente');
        } catch (error) {
            console.error('Error creando gráfico de línea:', error);
        }
    }

    // Gráfico Circular - Distribución de Ingresos
    const pieCtx = document.getElementById('pieChart');
    if (pieCtx) {
        try {
            new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: datosGraficos.distribucionIngresos.labels,
                    datasets: [{
                        data: datosGraficos.distribucionIngresos.data,
                        backgroundColor: [
                            '#007bff', '#28a745', '#ffc107', '#dc3545', '#6c757d',
                            '#17a2b8', '#6610f2', '#e83e8c', '#fd7e14', '#20c997'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: $${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            console.log('Gráfico circular creado correctamente');
        } catch (error) {
            console.error('Error creando gráfico circular:', error);
        }
    }

    // Gráfico de Barras - Top Métodos de Pago
    const barCtx = document.getElementById('barChart');
    if (barCtx) {
        try {
            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: datosGraficos.topIngresos.labels,
                    datasets: [{
                        label: 'Monto ($)',
                        data: datosGraficos.topIngresos.data,
                        backgroundColor: '#007bff',
                        borderWidth: 0,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `$${context.raw.toLocaleString()}`;
                                }
                            }
                        }
                    }
                }
            });
            console.log('Gráfico de barras creado correctamente');
        } catch (error) {
            console.error('Error creando gráfico de barras:', error);
        }
    }

    // Gráfico de Dona - Distribución de Gastos
    const doughnutCtx = document.getElementById('doughnutChart');
    if (doughnutCtx) {
        try {
            new Chart(doughnutCtx, {
                type: 'doughnut',
                data: {
                    labels: datosGraficos.distribucionGastos.labels,
                    datasets: [{
                        data: datosGraficos.distribucionGastos.data,
                        backgroundColor: [
                            '#007bff', '#28a745', '#ffc107', '#dc3545', '#6c757d',
                            '#17a2b8', '#6610f2', '#e83e8c', '#fd7e14', '#20c997'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: $${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '50%'
                }
            });
            console.log('Gráfico de dona creado correctamente');
        } catch (error) {
            console.error('Error creando gráfico de dona:', error);
        }
    }

    // Funcionalidad de búsqueda en tablas
    const searchPagos = document.getElementById('searchPagos');
    if (searchPagos) {
        searchPagos.addEventListener('keyup', function() {
            const filter = this.value.toLowerCase();
            const rows = document.querySelectorAll('#tablaPagos tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        });
    }

    const searchDeudas = document.getElementById('searchDeudas');
    if (searchDeudas) {
        searchDeudas.addEventListener('keyup', function() {
            const filter = this.value.toLowerCase();
            const rows = document.querySelectorAll('#tablaDeudas tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        });
    }
}

function cambiarPeriodo() {
    const periodo = document.getElementById('periodoSelect').value;
    window.location.href = `/admin/dashboard_f?periodo=${periodo}`;
}

function exportarDatos() {
    alert('Funcionalidad de exportación en desarrollo');
}

// Mostrar mensaje de carga
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard de finanzas cargado');
});
</script>
{% endblock %}

