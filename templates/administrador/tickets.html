{% extends 'administrador/base.html' %}
{% block title %}Gestión de Tickets{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='administrador/tickets.css') }}">
{% endblock %}
{% block content %}
<div class="header" style="display: flex; align-items: center; gap: 18px;">
    <h1 style="margin:0;">Gestión de Tickets</h1>
    <span style="margin-left:auto;"></span>
    <a href="{{ url_for('admin.logout') }}" class="logout-btn">Cerrar sesión</a>
</div>

<!-- Mostrar mensajes flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }}" style="margin: 20px 0; padding: 12px; border-radius: 4px; background: {% if category == 'success' %}#d4edda{% else %}#f8d7da{% endif %}; color: {% if category == 'success' %}#155724{% else %}#721c24{% endif %}; border: 1px solid {% if category == 'success' %}#c3e6cb{% else %}#f5c6cb{% endif %};">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<!-- Estadísticas de Tickets -->
<div class="stats-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
    <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;">
        <div style="font-size: 2rem; color: #3498db; margin-bottom: 5px;">{{ total_tickets }}</div>
        <div style="color: #666; font-size: 0.9rem;">Tickets Totales</div>
    </div>
    <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;">
        <div style="font-size: 2rem; color: #f39c12; margin-bottom: 5px;">{{ pendientes }}</div>
        <div style="color: #666; font-size: 0.9rem;">Pendientes</div>
    </div>
    <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;">
        <div style="font-size: 2rem; color: #27ae60; margin-bottom: 5px;">{{ resueltos }}</div>
        <div style="color: #666; font-size: 0.9rem;">Resueltos</div>
    </div>
</div>

<!-- Filtros y Búsqueda -->
<div class="filters-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <div class="filter-group" style="display: flex; gap: 10px; align-items: center;">
            <label style="font-weight: bold;">Filtrar por:</label>
            <select id="filterEstado" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="all">Todos los estados</option>
                <option value="abierto">Abierto</option>
                <option value="pendiente">Pendiente</option>
                <option value="en progreso">En Progreso</option>
                <option value="resuelto">Resuelto</option>
                <option value="cerrado">Cerrado</option>
            </select>
            
            <select id="filterPrioridad" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="all">Todas las prioridades</option>
                <option value="alta">Alta</option>
                <option value="media">Media</option>
                <option value="baja">Baja</option>
                <option value="urgente">Urgente</option>
            </select>
        </div>
        
        <div style="margin-left: auto; display: flex; gap: 10px;">
            <label for="searchTickets" style="display: none;">Buscar tickets</label>
            <input type="text" id="searchTickets" placeholder="Buscar tickets..." style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; min-width: 250px;">
            <button onclick="filtrarTickets()" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Buscar</button>
        </div>
    </div>
</div>

<!-- Lista de Tickets -->
<div class="tickets-container" style="background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden;">
    <div style="overflow-x: auto;">
        <div class="tickets-header" style="background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #eee; display: grid; grid-template-columns: minmax(60px, 80px) minmax(150px, 1fr) minmax(80px, 100px) minmax(80px, 100px) minmax(100px, 120px) minmax(120px, 150px) minmax(100px, 120px) minmax(80px, 100px); gap: 15px; font-weight: bold; min-width: 800px;">
            <div>ID</div>
            <div>Descripción</div>
            <div>Prioridad</div>
            <div>Estado</div>
            <div>Fecha</div>
            <div>Ubicación</div>
            <div>Asignado a</div>
            <div>Acciones</div>
        </div>
        
        <div class="tickets-list" id="ticketsList" style="min-width: 800px;">
            {% for ticket in tickets %}
            <div class="ticket-item" data-estado="{{ ticket.estado }}" data-prioridad="{{ ticket.prioridad }}" 
                 data-tipo="{{ ticket.tipo_ubicacion }}"
                 style="padding: 15px 20px; border-bottom: 1px solid #eee; display: grid; grid-template-columns: minmax(60px, 80px) minmax(150px, 1fr) minmax(80px, 100px) minmax(80px, 100px) minmax(100px, 120px) minmax(120px, 150px) minmax(100px, 120px) minmax(80px, 100px); gap: 15px; align-items: center; transition: background-color 0.2s;">
                <div style="font-weight: bold; color: #3498db;">#{{ ticket.id_ticket }}</div>
                <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ ticket.descripcion }}">
                    {{ ticket.descripcion[:80] }}{% if ticket.descripcion|length > 80 %}...{% endif %}
                </div>
                <div>
                    <span class="priority-badge 
                        {% if ticket.prioridad == 'alta' or ticket.prioridad == 'urgente' %}priority-high{% endif %}
                        {% if ticket.prioridad == 'media' %}priority-medium{% endif %}
                        {% if ticket.prioridad == 'baja' %}priority-low{% endif %}"
                        style="padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; text-transform: uppercase;">
                        {{ ticket.prioridad }}
                    </span>
                </div>
                <div>
                    <span class="status-badge 
                        {% if ticket.estado == 'pendiente' or ticket.estado == 'abierto' %}status-pending{% endif %}
                        {% if ticket.estado == 'en progreso' %}status-progress{% endif %}
                        {% if ticket.estado == 'resuelto' or ticket.estado == 'cerrado' %}status-resolved{% endif %}"
                        style="padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">
                        {{ ticket.estado|title }}
                    </span>
                </div>
                <div style="font-size: 0.9rem; color: #666;">{{ ticket.fecha_emision.strftime('%d/%m/%Y') }}</div>
                <div style="font-size: 0.9rem;">
                    {% if ticket.tipo_ubicacion == 'departamento' %}
                        <i class="fas fa-building" style="color: #3498db; margin-right: 5px;"></i>
                        Piso {{ ticket.piso }} - Dpto. {{ ticket.nro_departamento }}
                    {% elif ticket.tipo_ubicacion == 'area_comun' %}
                        <i class="fas fa-users" style="color: #27ae60; margin-right: 5px;"></i>
                        {{ ticket.area_nombre }}
                    {% else %}
                        <i class="fas fa-question-circle" style="color: #95a5a6; margin-right: 5px;"></i>
                        Sin ubicación
                    {% endif %}
                </div>
                <div style="font-size: 0.9rem;">{{ ticket.empleado_nombre }}</div>
                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                    <button onclick="verDetalleTicket('{{ ticket.id_ticket }}')" 
                            style="background: #3498db; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        Ver
                    </button>
                    
                    <!-- Estados donde se puede ASIGNAR: abierto, pendiente -->
                    {% if ticket.estado in ['abierto', 'pendiente', 'nuevo'] %}
                    <button onclick="asignarTicket('{{ ticket.id_ticket }}')" 
                            style="background: #27ae60; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        Asignar
                    </button>
                    {% endif %}
                    
                    <!-- Estados donde se puede RESOLVER: abierto, pendiente, en progreso -->
                    {% if ticket.estado in ['abierto', 'pendiente', 'en progreso', 'asignado'] %}
                    <button onclick="marcarComoResuelto('{{ ticket.id_ticket }}')" 
                            style="background: #f39c12; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        Resolver
                    </button>
                    {% endif %}
                    
                    <!-- Estados donde se puede REABRIR: resuelto, cerrado -->
                    {% if ticket.estado in ['resuelto', 'cerrado'] %}
                    <button onclick="reabrirTicket('{{ ticket.id_ticket }}')" 
                            style="background: #9b59b6; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        Reabrir
                    </button>
                    {% endif %}
                    
                    <!-- Estados donde se puede ELIMINAR: resuelto, cerrado -->
                    {% if ticket.estado in ['resuelto', 'cerrado'] %}
                    <button onclick="eliminarTicket('{{ ticket.id_ticket }}')" 
                            style="background: #e74c3c; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        Eliminar
                    </button>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div style="padding: 40px; text-align: center; color: #666; min-width: 800px;">
                No hay tickets registrados
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Modal Detalle Ticket -->
<div id="ticketModal" role="dialog" aria-labelledby="modalTitle" aria-modal="true" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; width: 90%; max-width: 800px; max-height: 90vh; border-radius: 8px; overflow: hidden;">
        <div style="background: #3498db; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
            <h3 id="modalTitle" style="margin: 0;">Detalle del Ticket #<span id="modalTicketId"></span></h3>
            <button onclick="cerrarModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">×</button>
        </div>
        <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <strong>Ubicación:</strong> <span id="modalUbicacion"></span>
                </div>
                <div>
                    <strong>Fecha de Emisión:</strong> <span id="modalFecha"></span>
                </div>
                <div>
                    <strong>Prioridad:</strong> <span id="modalPrioridad"></span>
                </div>
                <div>
                    <strong>Estado:</strong> <span id="modalEstado"></span>
                </div>
                <div>
                    <strong>Responsable:</strong> <span id="modalResidente"></span>
                </div>
                <div>
                    <strong>Contacto:</strong> <span id="modalContacto"></span>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <strong>Descripción:</strong>
                <p id="modalDescripcion" style="margin: 10px 0 0 0; padding: 15px; background: #f8f9fa; border-radius: 4px;"></p>
            </div>
            
            <div style="margin-bottom: 20px;">
                <strong>Asignado a:</strong>
                <p id="modalAsignado" style="margin: 10px 0 0 0;"></p>
            </div>
            
            <div>
                <strong>Comentarios:</strong>
                <div id="modalComentarios" style="margin-top: 10px; max-height: 200px; overflow-y: auto;">
                    <!-- Los comentarios se cargarán aquí -->
                </div>
                
                <div style="margin-top: 20px;">
                    <label for="nuevoComentario" style="display: block; margin-bottom: 5px; font-weight: bold;">Agregar comentario:</label>
                    <textarea id="nuevoComentario" placeholder="Escriba su comentario aquí..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                    <div style="margin-top: 10px;">
                        <input type="checkbox" id="comentarioInterno">
                        <label for="comentarioInterno" style="font-size: 0.9rem;">Comentario interno (solo para administradores y empleados)</label>
                    </div>
                    <button onclick="agregarComentario()" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px;">Agregar Comentario</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Asignar Ticket -->
<div id="asignarModal" role="dialog" aria-labelledby="asignarTitle" aria-modal="true" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; width: 90%; max-width: 600px; border-radius: 8px; overflow: hidden;">
        <div style="background: #27ae60; color: white; padding: 20px;">
            <h3 id="asignarTitle" style="margin: 0;">Asignar Ticket #<span id="asignarTicketId"></span></h3>
        </div>
        <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
            <!-- Información del Ticket -->
            <div id="ticketInfo" style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                <h5>Información del Ticket</h5>
                <p id="ticketDescripcionAsignar" style="margin: 0; font-style: italic;"></p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                    <div><strong>Prioridad:</strong> <span id="ticketPrioridadAsignar"></span></div>
                    <div><strong>Ubicación:</strong> <span id="ticketUbicacionAsignar"></span></div>
                </div>
            </div>
            
            <!-- Tipo de Asignación -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">Tipo de Asignación *</label>
                <div style="display: flex; gap: 15px;">
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="radio" name="tipoAsignacion" value="interno" checked onchange="toggleTipoAsignacion()">
                        Empleado Interno
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="radio" name="tipoAsignacion" value="externo" onchange="toggleTipoAsignacion()">
                        Servicio Externo
                    </label>
                </div>
            </div>
            
            <!-- Selector de Empleado (Interno) -->
            <div id="seccionInterno" style="margin-bottom: 20px;">
                <label for="empleadoAsignado" style="display: block; margin-bottom: 8px; font-weight: bold;">Seleccionar Empleado *</label>
                <select id="empleadoAsignado" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;">
                    <option value="">Cargando empleados...</option>
                </select>
            </div>
            
            <!-- Servicio Externo -->
            <div id="seccionExterno" style="margin-bottom: 20px; display: none;">
                <label for="proveedorExterno" style="display: block; margin-bottom: 8px; font-weight: bold;">Proveedor Externo *</label>
                <input type="text" id="proveedorExterno" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Nombre del proveedor o servicio externo">
                
                <label for="contactoExterno" style="display: block; margin-bottom: 8px; font-weight: bold; margin-top: 10px;">Contacto Externo</label>
                <input type="text" id="contactoExterno" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Teléfono o email de contacto">
            </div>
            
            <!-- Fecha Estimada -->
            <div style="margin-bottom: 20px;">
                <label for="fechaEstimada" style="display: block; margin-bottom: 8px; font-weight: bold;">Fecha Estimada de Finalización *</label>
                <input type="date" id="fechaEstimada" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" min="{{ hoy }}">
            </div>
            
            <!-- Instrucciones -->
            <div style="margin-bottom: 20px;">
                <label for="instruccionesAsignacion" style="display: block; margin-bottom: 8px; font-weight: bold;">Instrucciones Específicas</label>
                <textarea id="instruccionesAsignacion" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;" rows="4" placeholder="Agregue instrucciones detalladas..."></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="cerrarAsignarModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Cancelar</button>
                <button onclick="confirmarAsignacion()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Asignar Trabajo</button>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales
let ticketActual = null;
let empleadosDisponibles = [];

// Funciones del modal de detalle
async function verDetalleTicket(idTicket) {
    ticketActual = idTicket;
    
    try {
        console.log('Solicitando ticket #' + idTicket);
        
        const response = await fetch(`/admin/ticket/${idTicket}`);
        
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }
        
        const ticket = await response.json();
        console.log('Ticket recibido:', ticket);
        
        // Llenar el modal
        document.getElementById('modalTicketId').textContent = idTicket;
        document.getElementById('modalUbicacion').textContent = ticket.ubicacion || 'N/A';
        document.getElementById('modalFecha').textContent = ticket.fecha_emision || 'N/A';
        document.getElementById('modalPrioridad').innerHTML = `<span class="priority-badge priority-${ticket.prioridad}">${ticket.prioridad}</span>`;
        document.getElementById('modalEstado').innerHTML = `<span class="status-badge status-${ticket.estado}">${ticket.estado}</span>`;
        document.getElementById('modalDescripcion').textContent = ticket.descripcion || 'Sin descripción';
        document.getElementById('modalAsignado').textContent = ticket.empleado_asignado || 'No asignado';
        document.getElementById('modalResidente').textContent = ticket.residente_nombre || 'N/A';
        document.getElementById('modalContacto').textContent = ticket.residente_contacto || 'N/A';
        
        // Cargar comentarios
        const comentariosContainer = document.getElementById('modalComentarios');
        comentariosContainer.innerHTML = '';
        
        if (ticket.comentarios && ticket.comentarios.length > 0) {
            ticket.comentarios.forEach(comentario => {
                const comentarioDiv = document.createElement('div');
                comentarioDiv.style.padding = '10px';
                comentarioDiv.style.borderBottom = '1px solid #eee';
                comentarioDiv.style.backgroundColor = comentario.es_interno ? '#fff3cd' : '#ffffff';
                comentarioDiv.style.marginBottom = '10px';
                comentarioDiv.style.borderRadius = '4px';
                
                comentarioDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <strong>${comentario.usuario_nombre} (${comentario.rol_nombre})</strong>
                        <small style="color: #666;">${comentario.fecha_creacion}</small>
                    </div>
                    <p style="margin: 0; color: #333;">${comentario.mensaje}</p>
                    ${comentario.es_interno ? '<small style="color: #856404;">Comentario interno</small>' : ''}
                `;
                
                comentariosContainer.appendChild(comentarioDiv);
            });
        } else {
            comentariosContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay comentarios para este ticket</p>';
        }
        
        document.getElementById('ticketModal').style.display = 'flex';
        
    } catch (error) {
        console.error('Error cargando detalles del ticket:', error);
        alert(`Error al cargar el ticket: ${error.message}`);
    }
}

function cerrarModal() {
    document.getElementById('ticketModal').style.display = 'none';
    ticketActual = null;
}

async function agregarComentario() {
    const mensaje = document.getElementById('nuevoComentario').value;
    const esInterno = document.getElementById('comentarioInterno').checked;
    
    if (!mensaje.trim()) {
        alert('Por favor escriba un comentario');
        return;
    }
    
    try {
        const response = await fetch(`/admin/ticket/${ticketActual}/comentario`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                mensaje: mensaje,
                es_interno: esInterno
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('Comentario agregado correctamente');
            document.getElementById('nuevoComentario').value = '';
            verDetalleTicket(ticketActual);
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al agregar comentario');
    }
}

// Funciones de asignación
function toggleTipoAsignacion() {
    const tipo = document.querySelector('input[name="tipoAsignacion"]:checked').value;
    const seccionInterno = document.getElementById('seccionInterno');
    const seccionExterno = document.getElementById('seccionExterno');
    
    if (tipo === 'interno') {
        seccionInterno.style.display = 'block';
        seccionExterno.style.display = 'none';
    } else {
        seccionInterno.style.display = 'none';
        seccionExterno.style.display = 'block';
    }
}

async function cargarEmpleadosDisponibles() {
    try {
        const response = await fetch('/admin/empleados/disponibles');
        const empleados = await response.json();
        
        if (response.ok) {
            empleadosDisponibles = empleados;
            actualizarSelectEmpleados();
        } else {
            console.error('Error cargando empleados:', empleados.error);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function actualizarSelectEmpleados() {
    const select = document.getElementById('empleadoAsignado');
    select.innerHTML = '<option value="">Seleccione un empleado...</option>';
    
    empleadosDisponibles.forEach(empleado => {
        const option = document.createElement('option');
        option.value = empleado.id_empleado;
        option.textContent = `${empleado.nombre_completo} - ${empleado.puesto} (${empleado.turno})`;
        select.appendChild(option);
    });
}

async function asignarTicket(idTicket) {
    ticketActual = idTicket;
    
    await cargarEmpleadosDisponibles();
    document.getElementById('asignarTicketId').textContent = idTicket;
    
    // Resetear formulario
    document.querySelector('input[name="tipoAsignacion"][value="interno"]').checked = true;
    toggleTipoAsignacion();
    document.getElementById('proveedorExterno').value = '';
    document.getElementById('contactoExterno').value = '';
    document.getElementById('fechaEstimada').value = '';
    document.getElementById('instruccionesAsignacion').value = '';
    
    document.getElementById('asignarModal').style.display = 'flex';
}

async function confirmarAsignacion() {
    const tipoAsignacion = document.querySelector('input[name="tipoAsignacion"]:checked').value;
    const empleadoId = document.getElementById('empleadoAsignado').value;
    const proveedorExterno = document.getElementById('proveedorExterno').value;
    const contactoExterno = document.getElementById('contactoExterno').value;
    const fechaEstimada = document.getElementById('fechaEstimada').value;
    const instrucciones = document.getElementById('instruccionesAsignacion').value;
    
    if (tipoAsignacion === 'interno' && !empleadoId) {
        alert('Por favor seleccione un empleado');
        return;
    }
    
    if (tipoAsignacion === 'externo' && !proveedorExterno) {
        alert('Por favor ingrese el nombre del proveedor externo');
        return;
    }
    
    if (!fechaEstimada) {
        alert('Por favor ingrese una fecha estimada');
        return;
    }
    
    try {
        const asignacionData = {
            id_ticket: ticketActual,
            fecha_estimada: fechaEstimada,
            instrucciones: instrucciones
        };
        
        if (tipoAsignacion === 'interno') {
            asignacionData.id_empleado = empleadoId;
            asignacionData.tipo_asignacion = 'interno';
        } else {
            asignacionData.proveedor_externo = proveedorExterno;
            asignacionData.contacto_externo = contactoExterno;
            asignacionData.tipo_asignacion = 'externo';
        }
        
        const response = await fetch('/admin/tickets/asignar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(asignacionData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            cerrarAsignarModal();
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al asignar el ticket');
    }
}

function cerrarAsignarModal() {
    document.getElementById('asignarModal').style.display = 'none';
    ticketActual = null;
}

// Función para eliminar ticket
async function eliminarTicket(idTicket) {
    if (!confirm('¿Está seguro de que desea eliminar este ticket?')) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/ticket/${idTicket}/eliminar`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar el ticket');
    }
}

// Función para marcar ticket como resuelto
async function marcarComoResuelto(idTicket) {
    if (!confirm('¿Está seguro de que desea marcar este ticket como resuelto?')) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/ticket/${idTicket}/cambiar-estado`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                estado: 'resuelto'
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al marcar el ticket como resuelto');
    }
}

// Función para reabrir ticket
async function reabrirTicket(idTicket) {
    if (!confirm('¿Está seguro de que desea reabrir este ticket?')) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/ticket/${idTicket}/cambiar-estado`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                estado: 'abierto'
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al reabrir el ticket');
    }
}

// Filtrado de tickets
function filtrarTickets() {
    const estado = document.getElementById('filterEstado').value;
    const prioridad = document.getElementById('filterPrioridad').value;
    const busqueda = document.getElementById('searchTickets').value.toLowerCase();
    
    const tickets = document.querySelectorAll('.ticket-item');
    
    tickets.forEach(ticket => {
        const ticketEstado = ticket.getAttribute('data-estado');
        const ticketPrioridad = ticket.getAttribute('data-prioridad');
        const descripcion = ticket.querySelector('div:nth-child(2)').textContent.toLowerCase();
        const idTicket = ticket.querySelector('div:nth-child(1)').textContent.toLowerCase();
        
        const coincideEstado = estado === 'all' || ticketEstado === estado;
        const coincidePrioridad = prioridad === 'all' || ticketPrioridad === prioridad;
        const coincideBusqueda = descripcion.includes(busqueda) || idTicket.includes(busqueda);
        
        if (coincideEstado && coincidePrioridad && coincideBusqueda) {
            ticket.style.display = 'grid';
        } else {
            ticket.style.display = 'none';
        }
    });
}

// Event listeners
document.getElementById('filterEstado').addEventListener('change', filtrarTickets);
document.getElementById('filterPrioridad').addEventListener('change', filtrarTickets);
document.getElementById('searchTickets').addEventListener('input', filtrarTickets);

// Cerrar modales al hacer clic fuera
document.getElementById('ticketModal').addEventListener('click', function(e) {
    if (e.target === this) cerrarModal();
});

document.getElementById('asignarModal').addEventListener('click', function(e) {
    if (e.target === this) cerrarAsignarModal();
});

// Mejoras de accesibilidad - manejar tecla Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (document.getElementById('ticketModal').style.display === 'flex') {
            cerrarModal();
        }
        if (document.getElementById('asignarModal').style.display === 'flex') {
            cerrarAsignarModal();
        }
    }
});
</script>
{% endblock %}