{% extends 'administrador/base.html' %}
{% block title %}Gestión de Tickets{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='administrador/tickets.css') }}">
{% endblock %}
{% block content %}
<div class="header" style="display: flex; align-items: center; gap: 18px;">
    <h1 style="margin:0;">Gestión de Tickets</h1>
    <span style="margin-left:auto;"></span>
    <a href="{{ url_for('admin.logout') }}" class="logout-btn">Cerrar sesión</a>
</div>

<!-- Mostrar mensajes flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }}" style="margin: 20px 0; padding: 12px; border-radius: 4px; background: {% if category == 'success' %}#d4edda{% else %}#f8d7da{% endif %}; color: {% if category == 'success' %}#155724{% else %}#721c24{% endif %}; border: 1px solid {% if category == 'success' %}#c3e6cb{% else %}#f5c6cb{% endif %};">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<!-- Estadísticas de Tickets -->
<div class="stats-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
    <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;">
        <div style="font-size: 2rem; color: #3498db; margin-bottom: 5px;">{{ total_tickets }}</div>
        <div style="color: #666; font-size: 0.9rem;">Tickets Totales</div>
    </div>
    <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;">
        <div style="font-size: 2rem; color: #f39c12; margin-bottom: 5px;">{{ pendientes }}</div>
        <div style="color: #666; font-size: 0.9rem;">Pendientes</div>
    </div>
    <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;">
        <div style="font-size: 2rem; color: #3498db; margin-bottom: 5px;">{{ en_proceso }}</div>
        <div style="color: #666; font-size: 0.9rem;">En Proceso</div>
    </div>
    <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;">
        <div style="font-size: 2rem; color: #27ae60; margin-bottom: 5px;">{{ resueltos }}</div>
        <div style="color: #666; font-size: 0.9rem;">Resueltos</div>
    </div>
    <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;">
        <div style="font-size: 2rem; color: #e74c3c; margin-bottom: 5px;">{{ cancelados }}</div>
        <div style="color: #666; font-size: 0.9rem;">Cancelados</div>
    </div>
</div>

<!-- Filtros y Búsqueda -->
<div class="filters-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <div class="filter-group" style="display: flex; gap: 10px; align-items: center;">
            <label style="font-weight: bold;">Filtrar por:</label>
            <select id="filterEstado" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="all">Todos los estados</option>
                <option value="pendiente">Pendiente</option>
                <option value="en_proceso">En Proceso</option>
                <option value="resuelto">Resuelto</option>
                <option value="cancelado">Cancelado</option>
            </select>
            
            <select id="filterPrioridad" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="all">Todas las prioridades</option>
                <option value="alta">Alta</option>
                <option value="media">Media</option>
                <option value="baja">Baja</option>
            </select>
        </div>
        
        <div style="margin-left: auto; display: flex; gap: 10px;">
            <input type="text" id="searchTickets" placeholder="Buscar tickets..." style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; min-width: 250px;">
            <button onclick="filtrarTickets()" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Buscar</button>
        </div>
    </div>
</div>

<!-- Lista de Tickets -->
<div class="tickets-container" style="background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden;">
    <div class="tickets-header" style="background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #eee; display: grid; grid-template-columns: 80px 1fr 100px 100px 120px 150px 120px 100px; gap: 15px; font-weight: bold;">
        <div>ID</div>
        <div>Descripción</div>
        <div>Prioridad</div>
        <div>Estado</div>
        <div>Fecha</div>
        <div>Ubicación</div>
        <div>Asignado a</div>
        <div>Acciones</div>
    </div>
    
    <div class="tickets-list" id="ticketsList">
        {% for ticket in tickets %}
        <div class="ticket-item" data-estado="{{ ticket.estado }}" data-prioridad="{{ ticket.prioridad }}" 
             data-tipo="{{ ticket.tipo_ubicacion }}"
             style="padding: 15px 20px; border-bottom: 1px solid #eee; display: grid; grid-template-columns: 80px 1fr 100px 100px 120px 150px 120px 100px; gap: 15px; align-items: center; transition: background-color 0.2s;">
            <div style="font-weight: bold; color: #3498db;">#{{ ticket.id_ticket }}</div>
            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ ticket.descripcion }}">
                {{ ticket.descripcion[:80] }}{% if ticket.descripcion|length > 80 %}...{% endif %}
            </div>
            <div>
                <span class="priority-badge 
                    {% if ticket.prioridad == 'alta' %}priority-high{% endif %}
                    {% if ticket.prioridad == 'media' %}priority-medium{% endif %}
                    {% if ticket.prioridad == 'baja' %}priority-low{% endif %}"
                    style="padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; text-transform: uppercase;">
                    {{ ticket.prioridad }}
                </span>
            </div>
            <div>
                <span class="status-badge 
                    {% if ticket.estado == 'pendiente' %}status-pending{% endif %}
                    {% if ticket.estado == 'en_proceso' %}status-in-progress{% endif %}
                    {% if ticket.estado == 'resuelto' %}status-resolved{% endif %}
                    {% if ticket.estado == 'cancelado' %}status-cancelled{% endif %}"
                    style="padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">
                    {{ ticket.estado|replace('_', ' ')|title }}
                </span>
            </div>
            <div style="font-size: 0.9rem; color: #666;">{{ ticket.fecha_emision.strftime('%d/%m/%Y') }}</div>
            <div style="font-size: 0.9rem;">
                {% if ticket.tipo_ubicacion == 'departamento' %}
                    <i class="fas fa-building" style="color: #3498db; margin-right: 5px;"></i>
                    Piso {{ ticket.piso }} - Dpto. {{ ticket.nro_departamento }}
                {% elif ticket.tipo_ubicacion == 'area_comun' %}
                    <i class="fas fa-users" style="color: #27ae60; margin-right: 5px;"></i>
                    {{ ticket.area_nombre }}
                {% else %}
                    <i class="fas fa-question-circle" style="color: #95a5a6; margin-right: 5px;"></i>
                    Sin ubicación
                {% endif %}
            </div>
            <div style="font-size: 0.9rem;">{{ ticket.empleado_nombre }}</div>
            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                <button onclick="verDetalleTicket({{ ticket.id_ticket }})" 
                        style="background: #3498db; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                    Ver
                </button>
                {% if ticket.estado == 'pendiente' %}
                <button onclick="asignarTicket({{ ticket.id_ticket }})" 
                        style="background: #27ae60; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                    Asignar
                </button>
                {% elif ticket.estado == 'en_proceso' %}
                <button onclick="cambiarEstadoTicket({{ ticket.id_ticket }}, 'resuelto')" 
                        style="background: #27ae60; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                    Resolver
                </button>
                <button onclick="cambiarEstadoTicket({{ ticket.id_ticket }}, 'cancelado')" 
                        style="background: #e74c3c; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                    Cancelar
                </button>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div style="padding: 40px; text-align: center; color: #666;">
            No hay tickets registrados
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal Detalle Ticket -->
<div id="ticketModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; width: 90%; max-width: 800px; max-height: 90vh; border-radius: 8px; overflow: hidden;">
        <div style="background: #3498db; color: white; padding: 20px; display: flex; justify-content: between; align-items: center;">
            <h3 style="margin: 0;">Detalle del Ticket #<span id="modalTicketId"></span></h3>
            <button onclick="cerrarModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">×</button>
        </div>
        <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <strong>Ubicación:</strong> <span id="modalUbicacion"></span>
                </div>
                <div>
                    <strong>Fecha de Emisión:</strong> <span id="modalFecha"></span>
                </div>
                <div>
                    <strong>Prioridad:</strong> <span id="modalPrioridad"></span>
                </div>
                <div>
                    <strong>Estado:</strong> <span id="modalEstado"></span>
                </div>
                <div>
                    <strong>Responsable:</strong> <span id="modalResidente"></span>
                </div>
                <div>
                    <strong>Contacto:</strong> <span id="modalContacto"></span>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <strong>Descripción:</strong>
                <p id="modalDescripcion" style="margin: 10px 0 0 0; padding: 15px; background: #f8f9fa; border-radius: 4px;"></p>
            </div>
            
            <div style="margin-bottom: 20px;">
                <strong>Asignado a:</strong>
                <p id="modalAsignado" style="margin: 10px 0 0 0;"></p>
            </div>
            
            <div>
                <strong>Comentarios:</strong>
                <div id="modalComentarios" style="margin-top: 10px; max-height: 200px; overflow-y: auto;">
                    <!-- Los comentarios se cargarán aquí -->
                </div>
                
                <div style="margin-top: 20px;">
                    <textarea id="nuevoComentario" placeholder="Agregar un comentario..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                    <div style="margin-top: 10px;">
                        <input type="checkbox" id="comentarioInterno">
                        <label for="comentarioInterno" style="font-size: 0.9rem;">Comentario interno (solo para administradores y empleados)</label>
                    </div>
                    <button onclick="agregarComentario()" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px;">Agregar Comentario</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Asignar Ticket -->
<div id="asignarModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; width: 90%; max-width: 600px; border-radius: 8px; overflow: hidden;">
        <div style="background: #27ae60; color: white; padding: 20px;">
            <h3 style="margin: 0;">Asignar Ticket #<span id="asignarTicketId"></span></h3>
        </div>
        <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
            <!-- Información del Ticket -->
            <div id="ticketInfo" style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                <h5>Información del Ticket</h5>
                <p id="ticketDescripcionAsignar" style="margin: 0; font-style: italic;"></p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                    <div><strong>Prioridad:</strong> <span id="ticketPrioridadAsignar"></span></div>
                    <div><strong>Ubicación:</strong> <span id="ticketUbicacionAsignar"></span></div>
                </div>
            </div>
            
            <!-- Selector de Empleado -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">Seleccionar Empleado *</label>
                <select id="empleadoAsignado" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;">
                    <option value="">Cargando empleados...</option>
                </select>
                <div id="empleadoInfo" style="background: #e8f5e8; padding: 10px; border-radius: 4px; display: none;">
                    <strong>Información del empleado:</strong>
                    <div id="empleadoDetalles"></div>
                </div>
            </div>
            
            <!-- Fecha Estimada -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">Fecha Estimada de Finalización *</label>
                <input type="date" id="fechaEstimada" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" min="{{ hoy }}">
            </div>
            
            <!-- Instrucciones -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold;">Instrucciones Específicas</label>
                <textarea id="instruccionesAsignacion" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;" rows="4" placeholder="Agregue instrucciones detalladas para el empleado..."></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="cerrarAsignarModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Cancelar</button>
                <button onclick="confirmarAsignacion()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Asignar Trabajo</button>
            </div>
        </div>
    </div>
</div>

<style>

</style>

<script>
// Variables globales
let ticketActual = null;
let empleadosDisponibles = [];

// Funciones del modal de detalle
async function verDetalleTicket(idTicket) {
    ticketActual = idTicket;
    
    try {
        const response = await fetch(`/admin/ticket/${idTicket}`);
        const ticket = await response.json();
        
        if (response.ok) {
            document.getElementById('modalTicketId').textContent = idTicket;
            document.getElementById('modalUbicacion').textContent = ticket.ubicacion;
            document.getElementById('modalFecha').textContent = ticket.fecha_emision;
            document.getElementById('modalPrioridad').innerHTML = `<span class="priority-badge priority-${ticket.prioridad}">${ticket.prioridad}</span>`;
            document.getElementById('modalEstado').innerHTML = `<span class="status-badge status-${ticket.estado}">${ticket.estado.replace('_', ' ')}</span>`;
            document.getElementById('modalDescripcion').textContent = ticket.descripcion;
            document.getElementById('modalAsignado').textContent = ticket.empleado_asignado;
            document.getElementById('modalResidente').textContent = ticket.residente_nombre;
            document.getElementById('modalContacto').textContent = ticket.residente_contacto;
            
            // Cargar comentarios
            const comentariosContainer = document.getElementById('modalComentarios');
            comentariosContainer.innerHTML = '';
            
            if (ticket.comentarios && ticket.comentarios.length > 0) {
                ticket.comentarios.forEach(comentario => {
                    const comentarioDiv = document.createElement('div');
                    comentarioDiv.style.padding = '10px';
                    comentarioDiv.style.borderBottom = '1px solid #eee';
                    comentarioDiv.style.backgroundColor = comentario.es_interno ? '#fff3cd' : '#ffffff';
                    
                    comentarioDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <strong>${comentario.usuario_nombre} (${comentario.rol_nombre})</strong>
                            <small>${comentario.fecha_creacion}</small>
                        </div>
                        <p style="margin: 0;">${comentario.mensaje}</p>
                        ${comentario.es_interno ? '<small style="color: #856404;">Comentario interno</small>' : ''}
                    `;
                    
                    comentariosContainer.appendChild(comentarioDiv);
                });
            } else {
                comentariosContainer.innerHTML = '<p style="text-align: center; color: #666;">No hay comentarios</p>';
            }
            
            document.getElementById('ticketModal').style.display = 'flex';
        } else {
            alert('Error: ' + ticket.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar el ticket');
    }
}

function cerrarModal() {
    document.getElementById('ticketModal').style.display = 'none';
    ticketActual = null;
}

async function agregarComentario() {
    const mensaje = document.getElementById('nuevoComentario').value;
    const esInterno = document.getElementById('comentarioInterno').checked;
    
    if (!mensaje.trim()) {
        alert('Por favor escriba un comentario');
        return;
    }
    
    if (mensaje.length > 1000) {
        alert('El comentario no puede tener más de 1000 caracteres');
        return;
    }
    
    try {
        const response = await fetch(`/admin/ticket/${ticketActual}/comentario`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                mensaje: mensaje,
                es_interno: esInterno
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('Comentario agregado correctamente');
            document.getElementById('nuevoComentario').value = '';
            // Recargar los detalles del ticket para mostrar el nuevo comentario
            verDetalleTicket(ticketActual);
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al agregar comentario');
    }
}

// Funciones de asignación
async function cargarEmpleadosDisponibles() {
    try {
        const response = await fetch('/admin/empleados/disponibles');
        
        if (response.ok) {
            const empleados = await response.json();
            empleadosDisponibles = empleados;
            actualizarSelectEmpleados();
        } else {
            // Si hay error, usar empleados del template
            usarEmpleadosDelTemplate();
        }
    } catch (error) {
        console.error('Error cargando empleados:', error);
        usarEmpleadosDelTemplate();
    }
}

function usarEmpleadosDelTemplate() {
    // Los empleados ya vienen en la variable 'empleados' del template
    if (typeof empleados !== 'undefined' && empleados.length > 0) {
        empleadosDisponibles = empleados;
        actualizarSelectEmpleados();
    } else {
        const select = document.getElementById('empleadoAsignado');
        select.innerHTML = '<option value="">No hay empleados disponibles</option>';
    }
}

function actualizarSelectEmpleados() {
    const select = document.getElementById('empleadoAsignado');
    
    if (!empleadosDisponibles || empleadosDisponibles.length === 0) {
        select.innerHTML = '<option value="">No hay empleados disponibles</option>';
        return;
    }
    
    select.innerHTML = '<option value="">Seleccione un empleado...</option>';
    
    empleadosDisponibles.forEach(empleado => {
        const option = document.createElement('option');
        option.value = empleado.id_empleado;
        
        let texto = `${empleado.nombre_completo} - ${empleado.puesto}`;
        if (empleado.turno) {
            texto += ` (${empleado.turno})`;
        }
        if (empleado.tickets_activos !== undefined) {
            texto += ` - Tickets activos: ${empleado.tickets_activos}`;
        }
        if (empleado.disponibilidad) {
            texto += ` - ${empleado.disponibilidad}`;
        }
        
        option.textContent = texto;
        option.setAttribute('data-info', JSON.stringify(empleado));
        select.appendChild(option);
    });
}

// Mostrar información del empleado seleccionado
document.getElementById('empleadoAsignado').addEventListener('change', function() {
    const empleadoInfo = document.getElementById('empleadoInfo');
    const empleadoDetalles = document.getElementById('empleadoDetalles');
    
    if (this.value) {
        const empleado = empleadosDisponibles.find(e => e.id_empleado == this.value);
        if (empleado) {
            let detallesHTML = `
                <div><strong>Nombre:</strong> ${empleado.nombre_completo}</div>
                <div><strong>Puesto:</strong> ${empleado.puesto}</div>
            `;
            
            if (empleado.turno) {
                detallesHTML += `<div><strong>Turno:</strong> ${empleado.turno}</div>`;
            }
            if (empleado.tickets_activos !== undefined) {
                detallesHTML += `<div><strong>Tickets activos:</strong> ${empleado.tickets_activos}</div>`;
            }
            if (empleado.disponibilidad) {
                detallesHTML += `<div><strong>Disponibilidad:</strong> ${empleado.disponibilidad}</div>`;
            }
            
            empleadoDetalles.innerHTML = detallesHTML;
            empleadoInfo.style.display = 'block';
        }
    } else {
        empleadoInfo.style.display = 'none';
    }
});

async function asignarTicket(idTicket) {
    ticketActual = idTicket;
    
    // Cargar información del ticket
    const ticket = await obtenerTicket(idTicket);
    if (ticket) {
        document.getElementById('asignarTicketId').textContent = idTicket;
        document.getElementById('ticketDescripcionAsignar').textContent = ticket.descripcion;
        document.getElementById('ticketPrioridadAsignar').textContent = ticket.prioridad;
        document.getElementById('ticketUbicacionAsignar').textContent = ticket.ubicacion;
    }
    
    // Cargar empleados disponibles
    await cargarEmpleadosDisponibles();
    
    // Resetear formulario
    document.getElementById('fechaEstimada').value = '';
    document.getElementById('instruccionesAsignacion').value = '';
    document.getElementById('empleadoInfo').style.display = 'none';
    
    document.getElementById('asignarModal').style.display = 'flex';
}

async function confirmarAsignacion() {
    const empleadoId = document.getElementById('empleadoAsignado').value;
    const fechaEstimada = document.getElementById('fechaEstimada').value;
    const instrucciones = document.getElementById('instruccionesAsignacion').value;
    
    if (!empleadoId) {
        alert('Por favor seleccione un empleado');
        return;
    }
    
    if (!fechaEstimada) {
        alert('Por favor seleccione una fecha estimada');
        return;
    }
    
    // Validar fecha
    const hoy = new Date().toISOString().split('T')[0];
    if (fechaEstimada < hoy) {
        alert('La fecha estimada no puede ser en el pasado');
        return;
    }
    
    try {
        const response = await fetch('/admin/tickets/asignar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                id_ticket: ticketActual,
                id_empleado: empleadoId,
                fecha_estimada: fechaEstimada,
                instrucciones: instrucciones
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            cerrarAsignarModal();
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al asignar el ticket');
    }
}

function cerrarAsignarModal() {
    document.getElementById('asignarModal').style.display = 'none';
    ticketActual = null;
}

// Funciones de cambio de estado
async function cambiarEstadoTicket(idTicket, nuevoEstado) {
    const mensajes = {
        'resuelto': '¿Está seguro de que desea marcar este ticket como resuelto?',
        'cancelado': '¿Está seguro de que desea cancelar este ticket?'
    };
    
    if (!confirm(mensajes[nuevoEstado])) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/ticket/${idTicket}/cambiar-estado`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                estado: nuevoEstado
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.message);
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al cambiar el estado del ticket');
    }
}

// Funciones auxiliares
async function obtenerTicket(idTicket) {
    try {
        const response = await fetch(`/admin/ticket/${idTicket}`);
        if (response.ok) {
            return await response.json();
        }
    } catch (error) {
        console.error('Error obteniendo ticket:', error);
    }
    return null;
}

// Filtrado de tickets
function filtrarTickets() {
    const estado = document.getElementById('filterEstado').value;
    const prioridad = document.getElementById('filterPrioridad').value;
    const busqueda = document.getElementById('searchTickets').value.toLowerCase();
    
    const tickets = document.querySelectorAll('.ticket-item');
    
    tickets.forEach(ticket => {
        const ticketEstado = ticket.getAttribute('data-estado');
        const ticketPrioridad = ticket.getAttribute('data-prioridad');
        const descripcion = ticket.querySelector('div:nth-child(2)').textContent.toLowerCase();
        const idTicket = ticket.querySelector('div:nth-child(1)').textContent.toLowerCase();
        
        const coincideEstado = estado === 'all' || ticketEstado === estado;
        const coincidePrioridad = prioridad === 'all' || ticketPrioridad === prioridad;
        const coincideBusqueda = descripcion.includes(busqueda) || idTicket.includes(busqueda);
        
        if (coincideEstado && coincidePrioridad && coincideBusqueda) {
            ticket.style.display = 'grid';
        } else {
            ticket.style.display = 'none';
        }
    });
}

// Event listeners
document.getElementById('filterEstado').addEventListener('change', filtrarTickets);
document.getElementById('filterPrioridad').addEventListener('change', filtrarTickets);
document.getElementById('searchTickets').addEventListener('input', filtrarTickets);

// Cerrar modales al hacer clic fuera
document.getElementById('ticketModal').addEventListener('click', function(e) {
    if (e.target === this) cerrarModal();
});

document.getElementById('asignarModal').addEventListener('click', function(e) {
    if (e.target === this) cerrarAsignarModal();
});
</script>
{% endblock %}