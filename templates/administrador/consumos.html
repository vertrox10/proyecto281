{% extends 'administrador/base.html' %}
{% block title %}Dashboard de Consumos y Sensores{% endblock %}

{% block content %}
<div class="header" style="display: flex; align-items: center; gap: 18px;">
  <h1 style="margin:0;">📊 Dashboard Completo - Consumos & Sensores</h1>
  <span style="margin-left:auto;"></span>
  <link rel="stylesheet" href="{{ url_for('static', filename='administrador/style_consumo.css') }}">
  <a href="{{ url_for('admin.logout') }}" class="logout-btn">Cerrar sesión</a>
</div>

<!-- RESUMEN EJECUTIVO -->
<div class="resumen-ejecutivo mb-4">
  <div class="resumen-card">
    <h4>📈 Resumen General del Sistema - {{ current_month }}</h4>
    <div class="resumen-grid">
      <div class="resumen-item">
        <span class="resumen-label">Total Sensores:</span>
        <span class="resumen-valor">{{ metricas_sensores.total_sensores if metricas_sensores else 0 }}</span>
      </div>
      <div class="resumen-item">
        <span class="resumen-label">Sensores Activos:</span>
        <span class="resumen-valor text-success">{{ metricas_sensores.sensores_activos if metricas_sensores else 0 }}</span>
      </div>
      <div class="resumen-item">
        <span class="resumen-label">Departamentos Monitoreados:</span>
        <span class="resumen-valor">{{ metricas_sensores.deptos_con_sensores if metricas_sensores else 0 }}</span>
      </div>
      <div class="resumen-item">
        <span class="resumen-label">Total Registros Consumo:</span>
        <span class="resumen-valor">{{ consumos|length }}</span>
      </div>
    </div>
  </div>
</div>

<!-- COSTOS DE SERVICIOS -->
<div class="consumo-mensual-section mb-5">
  <h4>💧 COSTOS DE SERVICIOS MENSUALES</h4>
  <div class="consumo-grid">
    <!-- Agua -->
    <div class="consumo-card {% if agua.variacion <= 5 %}verde{% elif agua.variacion <= 15 %}amarillo{% else %}rojo{% endif %}">
      <div class="consumo-header">
        <h5>💧 Agua</h5>
        <span class="consumo-badge bg-primary">{{ agua.registros }} reg.</span>
      </div>
      <p class="costo">${{ agua.costo }}/mes</p>
      <p class="consumo-detalle">Consumo: {{ "%.2f"|format(agua.consumo_total) }} unidades</p>
      {% if agua.variacion < 0 %}
        <p class="variacion down">↘️ {{ agua.variacion | abs }}% vs anterior</p>
      {% else %}
        <p class="variacion up">↗️ {{ agua.variacion }}% vs anterior</p>
      {% endif %}
    </div>

    <!-- Gas -->
    <div class="consumo-card {% if gas.variacion <= 5 %}verde{% elif gas.variacion <= 15 %}amarillo{% else %}rojo{% endif %}">
      <div class="consumo-header">
        <h5>🔥 Gas</h5>
        <span class="consumo-badge bg-warning">{{ gas.registros }} reg.</span>
      </div>
      <p class="costo">${{ gas.costo }}/mes</p>
      <p class="consumo-detalle">Consumo: {{ "%.2f"|format(gas.consumo_total) }} unidades</p>
      {% if gas.variacion < 0 %}
        <p class="variacion down">↘️ {{ gas.variacion | abs }}% vs anterior</p>
      {% else %}
        <p class="variacion up">↗️ {{ gas.variacion }}% vs anterior</p>
      {% endif %}
    </div>

    <!-- Luz -->
    <div class="consumo-card {% if luz.variacion <= 5 %}verde{% elif luz.variacion <= 15 %}amarillo{% else %}rojo{% endif %}">
      <div class="consumo-header">
        <h5>💡 Luz</h5>
        <span class="consumo-badge bg-info">{{ luz.registros }} reg.</span>
      </div>
      <p class="costo">${{ luz.costo }}/mes</p>
      <p class="consumo-detalle">Consumo: {{ "%.2f"|format(luz.consumo_total) }} unidades</p>
      {% if luz.variacion < 0 %}
        <p class="variacion down">↘️ {{ luz.variacion | abs }}% vs anterior</p>
      {% else %}
        <p class="variacion up">↗️ {{ luz.variacion }}% vs anterior</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- INVENTARIO DE SENSORES -->
<div class="sensores-section mb-5">
  <div class="section-header">
    <h4>📡 Inventario de Sensores</h4>
    <div class="filtros">
      <span class="badge bg-primary">Total: {{ sensores|length }} sensores</span>
      <span class="badge bg-success">Activos: {{ metricas_sensores.sensores_activos if metricas_sensores else 0 }}</span>
    </div>
  </div>
  
  <div class="table-responsive">
    <table class="tabla-sensores">
      <thead>
        <tr>
          <th>ID SENSOR</th>
          <th>ÁREA</th>
          <th>DEPARTAMENTO</th>
          <th>NÚMERO DE SERIE</th>
          <th>CAPACIDAD</th>
          <th>ESTADO</th>
          <th>DESCRIPCIÓN</th>
        </tr>
      </thead>
      <tbody>
        {% if sensores %}
          {% for sensor in sensores %}
          <tr>
            <td><strong>{{ sensor.id_sensor }}</strong></td>
            <td><span class="badge bg-secondary">Área {{ sensor.id_area }}</span></td>
            <td><span class="badge bg-info">Depto {{ sensor.id_departamento }}</span></td>
            <td><code>{{ sensor.num_serie }}</code></td>
            <td>{{ sensor.capacidad }}</td>
            <td>
              {% if sensor.disponibilidad %}
                <span class="badge bg-success">✅ Activo</span>
              {% else %}
                <span class="badge bg-danger">❌ Inactivo</span>
              {% endif %}
            </td>
            <td><small>{{ sensor.descripcion or 'Sin descripción' }}</small></td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="7" class="text-center text-muted py-4">
              <div class="empty-state">
                <h5>📡 No hay sensores registrados</h5>
                <p>No se encontraron sensores en la base de datos.</p>
              </div>
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- REGISTROS DE CONSUMO -->
<div class="consumos-section">
  <div class="section-header">
    <h4>📋 Registros de Consumo - Últimos Registros</h4>
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="filtro-servicio">
        <label for="filtro-select" class="form-label"><strong>Filtrar por servicio:</strong></label>
        <select id="filtro-select" onchange="filtrarConsumos()" class="form-select" style="max-width: 300px;">
          <option value="todos">Todos los servicios</option>
          <option value="agua">💧 Agua</option>
          <option value="gas">🔥 Gas</option>
          <option value="luz">💡 Luz</option>
        </select>
      </div>
      <div class="export-buttons">
        <button onclick="exportarExcel()" class="btn btn-success">
          📥 Exportar a Excel
        </button>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="tabla-sensores" id="tabla-consumos">
      <thead>
        <tr>
          <th>SERVICIO</th>
          <th>SENSOR</th>
          <th>DEPARTAMENTO</th>
          <th>LECT. INICIAL</th>
          <th>LECT. FINAL</th>
          <th>CONSUMO REGISTRADO</th>
          <th>FECHA</th>
          <th>ESTADO</th>
        </tr>
      </thead>
      <tbody>
        {% if consumos %}
          {% for registro in consumos %}
          <tr class="fila-consumo" data-servicio="{{ registro.servicio }}">
            <td>
              {% if registro.servicio == 'agua' %}
                <span class="badge bg-primary">💧 AGUA</span>
              {% elif registro.servicio == 'gas' %}
                <span class="badge bg-warning">🔥 GAS</span>
              {% else %}
                <span class="badge bg-info">💡 LUZ</span>
              {% endif %}
            </td>
            <td><small>{{ registro.id_sensor }}</small></td>
            <td><strong>Depto {{ registro.id_departamento }}</strong></td>
            <td>{{ "%.2f"|format(registro.lectura_inicial) }}</td>
            <td>{{ "%.2f"|format(registro.lectura_final) }}</td>
            <td><strong>{{ "%.2f"|format(registro.cantidad_registrada) }}</strong></td>
            <td>{{ registro.fecha_registro.strftime('%d/%m/%Y %H:%M') }}</td>
            <td>
              {% set diferencia = registro.consumo_calculado %}
              {% if diferencia == registro.cantidad_registrada %}
                <span class="badge bg-success">✅ OK</span>
              {% else %}
                <span class="badge bg-warning">🟡 Diff</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="8" class="text-center text-muted py-4">
              <div class="empty-state">
                <h5>📊 No hay registros de consumo</h5>
                <p>No se encontraron registros en las tablas de consumo.</p>
              </div>
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Scripts al final del body -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
function filtrarConsumos() {
  const filtro = document.getElementById("filtro-select").value;
  const filas = document.querySelectorAll(".fila-consumo");

  filas.forEach(fila => {
    const servicio = fila.getAttribute("data-servicio");
    if (filtro === "todos" || servicio === filtro) {
      fila.style.display = "";
    } else {
      fila.style.display = "none";
    }
  });
}

function exportarExcel() {
  const tabla = document.getElementById('tabla-consumos');
  const wb = XLSX.utils.table_to_book(tabla, { sheet: "Consumos" });
  const fecha = new Date().toISOString().split('T')[0];
  XLSX.writeFile(wb, `consumos_${fecha}.xlsx`);
}

// Inicializar filtro al cargar
document.addEventListener('DOMContentLoaded', function() {
  filtrarConsumos();
});
</script>

<style>
.filtro-servicio {
  display: flex;
  align-items: center;
  gap: 10px;
}

.form-label {
  margin-bottom: 0;
  font-weight: 600;
}

.export-buttons {
  display: flex;
  align-items: center;
  gap: 10px;
}

.empty-state {
  padding: 40px;
  text-align: center;
  color: #6c757d;
}

.tabla-sensores {
  font-size: 0.85em;
}

.tabla-sensores th {
  background-color: #2c3e50;
  color: white;
  font-weight: 600;
  padding: 12px 8px;
}

.tabla-sensores td {
  padding: 10px 8px;
  vertical-align: middle;
}

.fila-consumo:hover {
  background-color: #f8f9fa;
}
</style>
{% endblock %}