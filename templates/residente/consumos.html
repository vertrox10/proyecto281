{% extends "residente/base_residente.html" %}

{% block title %}Mis Consumos{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='residente/consumos.css') }}">
{% endblock %}

{% block content %}
<div class="consumos-header">
    <h1>Mis Consumos</h1>
    <div class="periodo-selector">
        <select id="selectorPeriodo" class="form-control">
            {% for periodo in periodos %}
            <option value="{{ periodo.value }}" {% if periodo.selected %}selected{% endif %}>
                {{ periodo.nombre }}
            </option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="consumos-content">
    <!-- Resumen de Consumos -->
    <div class="resumen-consumos">
        <div class="consumo-card luz">
            <div class="consumo-icon">
                <i class="fas fa-bolt"></i>
            </div>
            <div class="consumo-info">
                <h3>Energía Eléctrica</h3>
                <div class="consumo-valor">{{ consumos_actual.luz }} kWh</div>
                <div class="consumo-variacion {{ 'positiva' if consumos_actual.variacion_luz > 0 else 'negativa' }}">
                    <i class="fas fa-arrow-{{ 'up' if consumos_actual.variacion_luz > 0 else 'down' }}"></i>
                    {{ consumos_actual.variacion_luz|abs }}% vs mes anterior
                </div>
            </div>
        </div>

        <div class="consumo-card agua">
            <div class="consumo-icon">
                <i class="fas fa-tint"></i>
            </div>
            <div class="consumo-info">
                <h3>Agua</h3>
                <div class="consumo-valor">{{ consumos_actual.agua }} m³</div>
                <div class="consumo-variacion {{ 'positiva' if consumos_actual.variacion_agua > 0 else 'negativa' }}">
                    <i class="fas fa-arrow-{{ 'up' if consumos_actual.variacion_agua > 0 else 'down' }}"></i>
                    {{ consumos_actual.variacion_agua|abs }}% vs mes anterior
                </div>
            </div>
        </div>

        <div class="consumo-card gas">
            <div class="consumo-icon">
                <i class="fas fa-fire"></i>
            </div>
            <div class="consumo-info">
                <h3>Gas Natural</h3>
                <div class="consumo-valor">{{ consumos_actual.gas }} m³</div>
                <div class="consumo-variacion {{ 'positiva' if consumos_actual.variacion_gas > 0 else 'negativa' }}">
                    <i class="fas fa-arrow-{{ 'up' if consumos_actual.variacion_gas > 0 else 'down' }}"></i>
                    {{ consumos_actual.variacion_gas|abs }}% vs mes anterior
                </div>
            </div>
        </div>

        <div class="consumo-card total">
            <div class="consumo-icon">
                <i class="fas fa-chart-pie"></i>
            </div>
            <div class="consumo-info">
                <h3>Total Estimado</h3>
                <div class="consumo-valor">${{ consumos_actual.total_estimado }}</div>
                <div class="consumo-detalle">Incluye todos los servicios</div>
            </div>
        </div>
    </div>

    <!-- Gráficos de Consumo -->
    <div class="charts-section">
        <div class="chart-row">
            <div class="chart-container large">
                <div class="chart-header">
                    <h3>Evolución de Consumos</h3>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <span class="legend-color luz"></span>
                            <span>Energía (kWh)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color agua"></span>
                            <span>Agua (m³)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color gas"></span>
                            <span>Gas (m³)</span>
                        </div>
                    </div>
                </div>
                <canvas id="evolucionConsumosChart"></canvas>
            </div>
        </div>

        <div class="chart-row">
            <div class="chart-container">
                <div class="chart-header">
                    <h3>Distribución Actual</h3>
                </div>
                <canvas id="distribucionConsumosChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h3>Comparativa Mensual</h3>
                </div>
                <canvas id="comparativaMensualChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Detalles de Lecturas -->
    <div class="detalles-section">
        <div class="section-card">
            <div class="card-header">
                <h3>Últimas Lecturas</h3>
                <button class="btn btn-outline" onclick="exportarLecturas()">
                    <i class="fas fa-download"></i> Exportar
                </button>
            </div>
            <div class="lecturas-grid">
                {% for lectura in lecturas %}
                <div class="lectura-card">
                    <div class="lectura-header">
                        <div class="lectura-tipo {{ lectura.tipo }}">
                            <i class="fas {{ lectura.icono }}"></i>
                            <span>{{ lectura.tipo|title }}</span>
                        </div>
                        <span class="lectura-fecha">{{ lectura.fecha }}</span>
                    </div>
                    <div class="lectura-valores">
                        <div class="lectura-item">
                            <label>Lectura Anterior:</label>
                            <span>{{ lectura.anterior }} {{ lectura.unidad }}</span>
                        </div>
                        <div class="lectura-item">
                            <label>Lectura Actual:</label>
                            <span>{{ lectura.actual }} {{ lectura.unidad }}</span>
                        </div>
                        <div class="lectura-item">
                            <label>Consumo:</label>
                            <span class="consumo-cantidad">{{ lectura.consumo }} {{ lectura.unidad }}</span>
                        </div>
                    </div>
                    <div class="lectura-sensor">
                        <i class="fas fa-microchip"></i>
                        <span>Sensor: {{ lectura.sensor }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Recomendaciones -->
    <div class="recomendaciones-section">
        <div class="section-card">
            <div class="card-header">
                <h3>Recomendaciones de Ahorro</h3>
            </div>
            <div class="recomendaciones-grid">
                {% for recomendacion in recomendaciones %}
                <div class="recomendacion-card">
                    <div class="recomendacion-icon {{ recomendacion.tipo }}">
                        <i class="fas {{ recomendacion.icono }}"></i>
                    </div>
                    <div class="recomendacion-content">
                        <h4>{{ recomendacion.titulo }}</h4>
                        <p>{{ recomendacion.descripcion }}</p>
                        <div class="recomendacion-ahorro">
                            <span>Ahorro estimado: {{ recomendacion.ahorro }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='residente/consumos.js') }}"></script>
{% endblock %}